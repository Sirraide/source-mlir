/// R %srcc %s --hlir
/// TODO: %srcc %s --llvm -O3

/// p nolit .
/// d any .*
/// p lit .

/// d t %[a-zA-Z0-9_]+

proc exit (i32) extern -> noreturn;
/// OPT: define void @__src_main()
/// OPT-NEXT: tail call void @exit(i32 42)

/// * func.func private @p1
proc p1 -> int {
    /// + (?<CHAIN1>$t) = hlir.local_var <!llvm.struct<"struct.anon.0"
    /// + (?<A>$t) = hlir.structgep $CHAIN1 $any, 0 : i32
    /// + hlir.zeroinitialiser $A
    int a;
    int c;

    /// * (?<CONST_1>$t) = arith.constant 4 : i64
    /// + hlir.store into $A : [^%]+, $CONST_1
    a = 4;

    /// * (?<P2>$t) = constant @p2
    /// * (?<CONST_2>$t) = arith.constant 4 : i64
    /// + call_indirect $P2($CONST_2, $CHAIN1)
    p2(4);

    /// * func.func private @p2
    proc p2(int b) {
        /// + (?<CHAIN2>$t) = hlir.local_var <!llvm.struct<"struct.anon.1"
        /// + hlir.store into $CHAIN2

        /// * (?<CHAIN1_1>$t) = hlir.extractlocal $CHAIN2 $any, 0 : i32
        /// + (?<A1>$t) = hlir.structgep $CHAIN1_1 $any, 0 : i32
        /// * (?<CONST_3>$t) = arith.constant 3 : i64
        /// + hlir.store into $A1 : [^%]+, $CONST_3
        a = 3;

        /// + (?<P3>$t) = constant @p3
        /// + call_indirect $P3($CHAIN2)
        p3();

        /// * func.func private @p3
        proc p3() {
            /// + (?<CHAIN3>$t) = hlir.local_var <!llvm.struct<"struct.anon.2"
            /// + hlir.store into $CHAIN3
            /// * (?<CHAIN2_1>$t) = hlir.extractlocal $CHAIN3 $any, 0 : i32
            /// + (?<B1>$t) = hlir.structgep $CHAIN2_1 $any, 1 : i32
            /// * (?<CONST_4>$t) = arith.constant 4 : i64
            /// + hlir.store into $B1 : [^%]+, $CONST_4
            b = 4;

            /// + (?<P4>$t) = constant @p4
            /// + call_indirect $P4($CHAIN3)
            p4();

            /// + (?<P5>$t) = constant @p5
            /// + (?<CONST_5>$t) = arith.constant 2 : i64
            /// + (?<CONST_6>$t) = arith.constant 3 : i64
            /// + (?<CHAIN2_X>$t) = hlir.extractlocal $CHAIN3 $any, 0 : i32
            /// + call_indirect $P5($CONST_5, $CONST_6, $CHAIN2_X)
            p5(2, 3);

            /// * func.func private @p4
            proc p4 {
                /// + (?<CHAIN4>$t) = hlir.local_var <!llvm.struct<"struct.anon.3"
                /// + hlir.store into $CHAIN4
                /// + (?<CHAIN3_1>$t) = hlir.extractlocal $CHAIN4 $any, 0 : i32
                /// + (?<CHAIN2_2>$t) = hlir.extractlocal $CHAIN3_1 $any, 0 : i32
                /// + (?<CHAIN1_2>$t) = hlir.extractlocal $CHAIN2_2 $any, 0 : i32
                /// + (?<A2>$t) = hlir.structgep $CHAIN1_2 $any, 0 : i32
                /// + (?<CONST_7>$t) = arith.constant 8 : i64
                /// + hlir.store into $A2 : [^%]+, $CONST_7
                a = 8;

                /// + (?<P5_2>$t) = constant @p5
                /// + (?<CONST_8>$t) = arith.constant 4 : i64
                /// + (?<CONST_9>$t) = arith.constant 5 : i64
                /// + (?<CHAIN3_2>$t) = hlir.extractlocal $CHAIN4 $any, 0 : i32
                /// + (?<CHAIN2_3>$t) = hlir.extractlocal $CHAIN3_2 $any, 0 : i32
                /// + call_indirect $P5_2($CONST_8, $CONST_9, $CHAIN2_3)
                p5(4, 5);
            }
        }

        /// * func.func private @p5
        proc p5(int, int) {
            /// + (?<CHAIN5>$t) = hlir.local_var <!llvm.struct<"struct.anon.4"
            /// + hlir.store into $CHAIN5

            /// * (?<CHAIN2_4>$t) = hlir.extractlocal $CHAIN5 $any, 0 : i32
            /// + (?<CHAIN1_3>$t) = hlir.extractlocal $CHAIN2_4 $any, 0 : i32
            /// + (?<A3>$t) = hlir.structgep $CHAIN1_3 $any, 0 : i32
            /// + (?<CONST_10>$t) = arith.constant 42 : i64
            /// + hlir.store into $A3 : [^%]+, $CONST_10
            a = 42;

            /// * (?<CHAIN2_5>$t) = hlir.extractlocal $CHAIN5 $any, 0 : i32
            /// + (?<B2>$t) = hlir.structgep $CHAIN2_5 $any, 1 : i32
            /// + (?<CONST_11>$t) = arith.constant 6 : i64
            /// + hlir.store into $B2 : [^%]+, $CONST_11
            b = 6;
        }
    }

    return a;
}

/// Check that no static chain is generated if no
/// variable is actually captured.
///
/// * func.func private @p6
/// ! hlir.extractlocal
/// ! hlir.structgep
proc p6 {
    int a;

    /// * func.func private @p7
    /// ! hlir.extractlocal
    /// ! hlir.structgep
    proc p7 {
        int b;
        b = 17;
    }
}

int ret = p1();
exit ret as i32;